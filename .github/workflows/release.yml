name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Install Apple certificate
        env:
          CERTIFICATE_P12: ${{ secrets.DEVELOPER_ID_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate
          printf '%s' "$CERTIFICATE_P12" | base64 -D > $CERTIFICATE_PATH

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          BUILD_NUM=$(git tag | wc -l | tr -d ' ')
          echo "build=$BUILD_NUM" >> $GITHUB_OUTPUT
      
      - name: Update version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" Pomo/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.build }}" Pomo/Info.plist
      
      - name: Build app
        run: |
          xcodebuild -project Pomo.xcodeproj \
            -scheme Pomo \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            MACOSX_DEPLOYMENT_TARGET=14.0 \
            build
          
          mkdir -p build
          cp -R "build/DerivedData/Build/Products/Release/Pomo.app" build/
      
      - name: Sign app with Developer ID
        run: |
          codesign --force --deep --options runtime \
            --sign "Developer ID Application: ${{ secrets.DEVELOPER_NAME }} (${{ secrets.TEAM_ID }})" \
            "build/Pomo.app"
          
          codesign --verify --deep --strict --verbose=2 "build/Pomo.app"
          echo "✅ App signed"
      
      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          ditto -c -k --keepParent "build/Pomo.app" "build/Pomo.zip"
          
          xcrun notarytool submit "build/Pomo.zip" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APP_SPECIFIC_PASSWORD" \
            --wait
          
          xcrun stapler staple "build/Pomo.app"
          echo "✅ App notarized"
      
      - name: Download Sparkle tools
        run: |
          SPARKLE_VERSION="2.6.4"
          curl -L "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz" -o sparkle.tar.xz
          mkdir -p sparkle-tools
          tar -xf sparkle.tar.xz -C sparkle-tools
      
      - name: Create DMG
        run: |
          brew install create-dmg
          
          create-dmg \
            --volname "Pomo" \
            --volicon "Pomo/Assets.xcassets/AppIcon.appiconset/icon_512x512.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Pomo.app" 150 185 \
            --app-drop-link 450 185 \
            --hide-extension "Pomo.app" \
            "build/Pomo.dmg" \
            "build/Pomo.app" || true
      
      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          APP_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool submit "build/Pomo.dmg" \
            --apple-id "$APPLE_ID" \
            --team-id "$TEAM_ID" \
            --password "$APP_SPECIFIC_PASSWORD" \
            --wait
          
          xcrun stapler staple "build/Pomo.dmg"
          echo "✅ DMG notarized"
      
      - name: Sign DMG with Sparkle
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
          
          SIGN_OUTPUT=$(./sparkle-tools/bin/sign_update build/Pomo.dmg --ed-key-file /tmp/sparkle_private_key)
          
          SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -oE 'sparkle:edSignature="[^"]+"' | cut -d'"' -f2)
          LENGTH=$(stat -f%z build/Pomo.dmg)
          
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "length=$LENGTH" >> $GITHUB_OUTPUT
          
          rm /tmp/sparkle_private_key
      
      - name: Update appcast.xml
        run: |
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          VERSION="${{ steps.version.outputs.version }}"
          BUILD="${{ steps.version.outputs.build }}"
          SIGNATURE="${{ steps.sign.outputs.signature }}"
          LENGTH="${{ steps.sign.outputs.length }}"
          
          cat > /tmp/new_item.xml << XMLEOF
            <item>
              <title>Version ${VERSION}</title>
              <description><![CDATA[<h2>What's New in ${VERSION}</h2><p>See the <a href="https://github.com/claudfuen/Pomo/releases/tag/v${VERSION}">release notes</a> for details.</p>]]></description>
              <pubDate>${DATE}</pubDate>
              <sparkle:version>${BUILD}</sparkle:version>
              <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
              <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
              <enclosure url="https://github.com/claudfuen/Pomo/releases/download/v${VERSION}/Pomo.dmg" sparkle:edSignature="${SIGNATURE}" length="${LENGTH}" type="application/octet-stream"/>
            </item>
          XMLEOF
          
          sed -i '' '/-->/r /tmp/new_item.xml' appcast.xml
          rm /tmp/new_item.xml
      
      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for v${{ steps.version.outputs.version }}"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Pomo v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: build/Pomo.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
