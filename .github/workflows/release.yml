name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          # Calculate build number from git tags count
          BUILD_NUM=$(git tag | wc -l | tr -d ' ')
          echo "build=$BUILD_NUM" >> $GITHUB_OUTPUT
      
      - name: Update version in Info.plist
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ steps.version.outputs.version }}" Pomo/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ steps.version.outputs.build }}" Pomo/Info.plist
      
      - name: Build app
        run: |
          xcodebuild -project Pomo.xcodeproj \
            -scheme Pomo \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            MACOSX_DEPLOYMENT_TARGET=14.0 \
            build
          
          # Copy app to build directory
          mkdir -p build
          cp -R "build/DerivedData/Build/Products/Release/Pomo.app" build/
      
      - name: Download Sparkle tools
        run: |
          SPARKLE_VERSION="2.6.4"
          curl -L "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz" -o sparkle.tar.xz
          mkdir -p sparkle-tools
          tar -xf sparkle.tar.xz -C sparkle-tools
      
      - name: Create DMG
        run: |
          # Create DMG directory
          mkdir -p build/dmg
          cp -R build/Pomo.app build/dmg/
          ln -s /Applications build/dmg/Applications
          
          # Create DMG
          hdiutil create -volname "Pomo" \
            -srcfolder build/dmg \
            -ov -format UDZO \
            -imagekey zlib-level=9 \
            build/Pomo.dmg
          
          # Clean up
          rm -rf build/dmg
      
      - name: Sign DMG with Sparkle
        id: sign
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write private key to temp file
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
          
          # Sign the DMG
          SIGN_OUTPUT=$(./sparkle-tools/bin/sign_update build/Pomo.dmg --ed-key-file /tmp/sparkle_private_key)
          
          # Extract signature
          SIGNATURE=$(echo "$SIGN_OUTPUT" | grep -oE 'sparkle:edSignature="[^"]+"' | cut -d'"' -f2)
          LENGTH=$(stat -f%z build/Pomo.dmg)
          
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "length=$LENGTH" >> $GITHUB_OUTPUT
          
          # Clean up
          rm /tmp/sparkle_private_key
      
      - name: Update appcast.xml
        run: |
          DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          VERSION="${{ steps.version.outputs.version }}"
          BUILD="${{ steps.version.outputs.build }}"
          SIGNATURE="${{ steps.sign.outputs.signature }}"
          LENGTH="${{ steps.sign.outputs.length }}"
          
          # Create new item entry
          NEW_ITEM=$(cat <<EOF
    <item>
      <title>Version ${VERSION}</title>
      <description>
        <![CDATA[
          <h2>What's New in ${VERSION}</h2>
          <p>See the <a href="https://github.com/claudfuen/Pomo/releases/tag/v${VERSION}">release notes</a> for details.</p>
        ]]>
      </description>
      <pubDate>${DATE}</pubDate>
      <sparkle:version>${BUILD}</sparkle:version>
      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>
      <enclosure 
        url="https://github.com/claudfuen/Pomo/releases/download/v${VERSION}/Pomo.dmg"
        sparkle:edSignature="${SIGNATURE}"
        length="${LENGTH}"
        type="application/octet-stream"/>
    </item>
EOF
)
          
          # Insert new item after the comment block (before existing items)
          # Using awk to insert after the --> line
          awk -v new_item="$NEW_ITEM" '
            /^[[:space:]]*-->/ { print; print ""; print new_item; next }
            { print }
          ' appcast.xml > appcast_new.xml
          
          mv appcast_new.xml appcast.xml
      
      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for v${{ steps.version.outputs.version }}"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Pomo v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: build/Pomo.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
